<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proactive Chat with User Verification (Developer Edition)</title>
</head>
<body>
    <h1>Welcome to My Website!</h1>
    <p>A proactive chat prompt will appear, attempting user verification.</p>
    <div id="chat-messages"></div>

    <script type='text/javascript'>
        function loadExternalScript(src, callback) {
            console.log('[DEBUG] [2025-08-26 16:50 EDT] Loading external script:', src);
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = src;
            script.id = 'proactiveChatScript';
            script.onload = () => {
                console.log('[DEBUG] [2025-08-26 16:50 EDT] External script loaded successfully.');
                callback();
            };
            script.onerror = () => {
                console.error('[ERROR] [2025-08-26 16:50 EDT] Failed to load script:', src);
            };
            document.head.appendChild(script);
        }

        class ProactiveChat {
            constructor(chatLogo, chatDelay, cancelText, chatText) {
                this.chatLogo = chatLogo;
                this.chatDelay = chatDelay;
                this.cancelText = cancelText;
                this.chatText = chatText;
                this.isUserVerificationEnabled = false;
            }

            generateStyles() {
                return `
                    <style>
                        .proactive-chat-container {
                            position: fixed;
                            bottom: -200px;
                            right: 20px;
                            width: 300px;
                            background-color: #ffffff;
                            border: 1px solid #ccc;
                            border-radius: 8px;
                            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                            font-family: Arial, sans-serif;
                            transition: bottom 0.5s ease-in-out;
                            z-index: 1000;
                        }
                        .proactive-chat-container.visible {
                            bottom: 20px;
                        }
                        .proactive-chat-header {
                            background-color: #007bff;
                            color: white;
                            padding: 10px;
                            border-top-left-radius: 8px;
                            border-top-right-radius: 8px;
                            font-weight: bold;
                        }
                        .proactive-chat-message {
                            padding: 10px;
                            color: #333;
                        }
                    </style>
                `;
            }

            createProactiveChat() {
                console.log('[DEBUG] [2025-08-26 16:50 EDT] Creating proactive chat UI...');
                document.head.insertAdjacentHTML('beforeend', this.generateStyles());
                const proactiveChatContainer = document.createElement('div');
                proactiveChatContainer.classList.add('proactive-chat-container');
                proactiveChatContainer.innerHTML = `
                    <div class="proactive-chat-header">Need Help?</div>
                    <div class="proactive-chat-message">
                        <img src="${this.chatLogo}" alt="Chat Logo" style="width: 50px; height: 50px; display: block; margin: 0 auto 10px;">
                        Hi! Connecting you to our support team...
                    </div>
                `;
                document.body.appendChild(proactiveChatContainer);
                setTimeout(() => {
                    console.log('[DEBUG] [2025-08-26 16:50 EDT] Showing proactive chat UI after delay...');
                    proactiveChatContainer.classList.add('visible');
                }, this.chatDelay);
                setTimeout(() => {
                    console.log('[DEBUG] [2025-08-26 16:50 EDT] Auto-hiding proactive chat UI...');
                    this.hideProactiveChat();
                }, this.chatDelay + 10000);
            }

            initEmbeddedProactiveMessaging(orgId, buttonName, baseUrl, scrt2URL) {
                console.log('[DEBUG] [2025-08-26 16:50 EDT] Initializing Embedded Messaging with parameters:', { orgId, buttonName, baseUrl });
                try {
                    embeddedservice_bootstrap.init(orgId, buttonName, baseUrl, {
                        scrt2URL: scrt2URL,
                        targetElement: '#chat-messages'
                    });
                    console.log('[DEBUG] [2025-08-26 16:50 EDT] Embedded Messaging initialized successfully.');
                } catch (err) {
                    console.error('[ERROR] [2025-08-26 16:50 EDT] Error initializing Embedded Messaging:', err);
                }
            }

            launchProactiveChat() {
                console.log('[DEBUG] [2025-08-26 16:50 EDT] Attempting to launch chat...');
                try {
                    embeddedservice_bootstrap.utilAPI.launchChat().then(success => {
                        console.log('[DEBUG] [2025-08-26 16:50 EDT] Chat launched successfully:', success);
                        this.hideProactiveChat();
                    }).catch(error => {
                        console.error('[ERROR] [2025-08-26 16:50 EDT] Error launching chat:', error);
                    });
                } catch (err) {
                    console.error('[ERROR] [2025-08-26 16:50 EDT] Error launching chat:', err);
                }
            }

            setIdentityToken(identityToken) {
                console.log('[DEBUG] [2025-08-26 16:50 EDT] Setting identity token...');
                try {
                    if (embeddedservice_bootstrap.userVerificationAPI) {
                        embeddedservice_bootstrap.userVerificationAPI.setIdentityToken({
                            identityTokenType: 'JWT',
                            identityToken: identityToken
                        });
                        console.log('[DEBUG] [2025-08-26 16:50 EDT] Identity token set successfully.');
                        this.isUserVerificationEnabled = true;
                    } else {
                        console.warn('[WARN] [2025-08-26 16:50 EDT] userVerificationAPI not available. User Verification not supported in Developer Edition (only Customer User Interface, Terms and Conditions, Business Hours available).');
                        this.isUserVerificationEnabled = false;
                    }
                } catch (err) {
                    console.error('[ERROR] [2025-08-26 16:50 EDT] Error setting identity token:', err);
                    console.warn('[WARN] [2025-08-26 16:50 EDT] User verification failed, likely due to missing JSON Web Key Sets or User Verification settings in Developer Edition.');
                    this.isUserVerificationEnabled = false;
                }
            }

            clearSession() {
                console.log('[DEBUG] [2025-08-26 16:50 EDT] Clearing session...');
                try {
                    if (embeddedservice_bootstrap.userVerificationAPI) {
                        embeddedservice_bootstrap.userVerificationAPI.clearSession();
                        console.log('[DEBUG] [2025-08-26 16:50 EDT] Session cleared successfully.');
                    } else {
                        console.warn('[WARN] [2025-08-26 16:50 EDT] userVerificationAPI not available for clearSession.');
                    }
                } catch (err) {
                    console.error('[ERROR] [2025-08-26 16:50 EDT] Error clearing session:', err);
                }
            }

            hideProactiveChat() {
                console.log('[DEBUG] [2025-08-26 16:50 EDT] Hiding proactive chat UI...');
                const proactiveChatContainer = document.querySelector('.proactive-chat-container');
                if (proactiveChatContainer) {
                    proactiveChatContainer.style.bottom = '-200px';
                    setTimeout(() => {
                        proactiveChatContainer.style.display = 'none';
                        console.log('[DEBUG] [2025-08-26 16:50 EDT] Proactive chat UI hidden.');
                    }, 500);
                }
                const script = document.getElementById('proactiveChatScript');
                if (script) {
                    script.remove();
                    console.log('[DEBUG] [2025-08-26 16:50 EDT] External script unloaded.');
                }
            }
        }

        let proactiveChat;

        function initProactive() {
            try {
                console.log('[DEBUG] [2025-08-26 16:50 EDT] Starting proactive chat initialization...');
                const chatLogo = 'https://example.com/your-logo.png'; // Replace with actual logo URL
                const chatDelay = 5000;
                proactiveChat = new ProactiveChat(chatLogo, chatDelay, 'Cancel', 'Chat');

                window.addEventListener('onEmbeddedMessagingReady', () => {
                    console.log('[DEBUG] [2025-08-26 16:50 EDT] onEmbeddedMessagingReady event received. API is ready.');
                    // Placeholder JWT; replace with JWT signed using Certificate and Key Management
                    const identityToken = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Ik1JQVdUZXN0Q2VydCJ9.eyJzdWIiOiJ1c2VyMTIzQGV4YW1wbGUuY29tIiwiaXNzIjoiU0YiLCJleHAiOjE3NDA4NzUxMDB9.SignatureHere';
                    proactiveChat.setIdentityToken(identityToken);
                    if (proactiveChat.isUserVerificationEnabled) {
                        console.log('[DEBUG] [2025-08-26 16:50 EDT] User verification enabled. Launching chat...');
                        proactiveChat.launchProactiveChat();
                    } else {
                        console.warn('[WARN] [2025-08-26 16:50 EDT] User verification not enabled, likely due to Developer Edition limitations (only Customer User Interface, Terms and Conditions, Business Hours available). Launching chat without verification...');
                        proactiveChat.launchProactiveChat();
                    }
                });

                window.addEventListener('onEmbeddedMessagingIdentityTokenExpired', () => {
                    console.warn('[WARN] [2025-08-26 16:50 EDT] Identity token expired. Attempting to generate new token...');
                    const newIdentityToken = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Ik1JQVdUZXN0Q2VydCJ9.eyJzdWIiOiJ1c2VyMTIzQGV4YW1wbGUuY29tIiwiaXNzIjoiU0YiLCJleHAiOjE3NDA4Nzg3MDB9.NewSignatureHere';
                    proactiveChat.setIdentityToken(newIdentityToken);
                });

                proactiveChat.createProactiveChat();
                proactiveChat.initEmbeddedProactiveMessaging(
                    '00DgL00000098b7', // Organization ID
                    'githubPOC', // Deployment Name
                    'https://orgfarm-699ab99d32-dev-ed.develop.my.site.com/ESWgithubPOC1755783616250', // Base URL
                    'https://orgfarm-699ab99d32-dev-ed.develop.my.salesforce-scrt.com' // Secure URL
                );
            } catch (err) {
                console.error('[ERROR] [2025-08-26 16:50 EDT] Error initializing proactive chat:', err);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('[DEBUG] [2025-08-26 16:50 EDT] DOM content loaded. Loading bootstrap script...');
            loadExternalScript('https://orgfarm-699ab99d32-dev-ed.develop.my.site.com/ESWgithubPOC1755783616250/assets/js/bootstrap.min.js', initProactive);
        });

        // Optional: Simulate logout after 30 seconds for testing
        setTimeout(() => {
            console.log('[DEBUG] [2025-08-26 16:50 EDT] Simulating logout...');
            if (proactiveChat) {
                proactiveChat.clearSession();
                window.addEventListener('onEmbeddedMessagingReady', () => {
                    console.log('[DEBUG] [2025-08-26 16:50 EDT] onEmbeddedMessagingReady event received after clearSession.');
                });
            }
        }, 30000);
    </script>
</body>
</html>
