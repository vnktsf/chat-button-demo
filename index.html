<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Click-to-Chat Example</title>
<style>
body {
  font-family: sans-serif;
  text-align: center;
  margin: 50px;
  background-color: #f0f0f0;
}
.chat-button {
  padding: 15px 30px;
  font-size: 18px;
  color: #fff;
  background-color: #0070d2;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}
.chat-button:hover {
  background-color: #005fb2;
}
#visitor-info {
  margin-top: 30px;
  text-align: left;
  display: inline-block;
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
#visitor-info input {
  width: 300px;
  padding: 5px;
  margin-bottom: 10px;
}
</style>
</head>
<body>
<h1>Welcome to My Website!</h1>
<p>Click the button below to start a conversation with us.</p>

<div id="visitor-info">
  <h2>Visitor Information</h2>

  <p>Email Address:<br><input type="email" id="email" placeholder="Enter your email"></p>
  <p>Marketing Email UID:<br><input type="text" id="marketing_uid" placeholder="Enter UID"></p>
  <p>Campaign Information:<br><input type="text" id="campaign_info" placeholder="Enter Campaign Info"></p>

  <p><b>Web URL:</b> <span id="web_url"></span></p>
  <p><b>Chat Origin:</b> <span id="chat_origin"></span></p>
  <p><b>Engagement Type:</b> <span id="engagement_type"></span></p>
  <p><b>Browser:</b> <span id="browser"></span></p>
  <p><b>Browser Language:</b> <span id="language"></span></p>
  <p><b>Referring Site:</b> <span id="referrer"></span></p>
  <p><b>Visitor IP Address:</b> <span id="ip"></span></p>
  <p><b>User Agent:</b> <span id="userAgent"></span></p>
  <p><b>Platform:</b> <span id="platform"></span></p>
  <p><b>Screen Resolution:</b> <span id="resolution"></span></p>
</div>

<button id="openChatButton" class="chat-button">Open Chat</button>

<script>
// Collect visitor info
const visitorData = {
  Browser: navigator.appName + " (" + navigator.appVersion + ")",
  Browser_Language: navigator.language || navigator.userLanguage,
  Referring_Site: document.referrer || "Direct / None",
  User_Agent: navigator.userAgent,
  Platform: navigator.platform,
  Screen_Resolution: window.screen.width + " x " + window.screen.height,
  Web_Url: window.location.href,
  Chat_Origin: "Website Chat",
  EngagementType: "Embedded Messaging",
  Visitor_IP_Address: "Fetching..."
};

// Display info
document.getElementById("browser").textContent = visitorData.Browser;
document.getElementById("language").textContent = visitorData.Browser_Language;
document.getElementById("referrer").textContent = visitorData.Referring_Site;
document.getElementById("userAgent").textContent = visitorData.User_Agent;
document.getElementById("platform").textContent = visitorData.Platform;
document.getElementById("resolution").textContent = visitorData.Screen_Resolution;
document.getElementById("web_url").textContent = visitorData.Web_Url;
document.getElementById("chat_origin").textContent = visitorData.Chat_Origin;
document.getElementById("engagement_type").textContent = visitorData.EngagementType;
document.getElementById("ip").textContent = visitorData.Visitor_IP_Address;

// Fetch IP
fetch("https://api.ipify.org?format=json")
  .then(r => r.json())
  .then(d => {
    visitorData.Visitor_IP_Address = d.ip;
    document.getElementById("ip").textContent = d.ip;
  })
  .catch(() => {
    visitorData.Visitor_IP_Address = "Unavailable";
    document.getElementById("ip").textContent = "Unavailable";
  });

// Reusable function to set prechat fields
function setPrechatFields() {
  if (!embeddedservice_bootstrap.prechatAPI) return;

  const visibleFields = {
    _firstName: {
      value: document.getElementById("email").value || "",
      isEditableByEndUser: true
    },
    _lastName: {
      value: document.getElementById("marketing_uid").value || "",
      isEditableByEndUser: true
    }
  };

  const hiddenFields = {
    Browser: visitorData.Browser,
   // Browser_Language: visitorData.Browser_Language,
   // Referring_Site: visitorData.Referring_Site,
    //Visitor_IP_Address: visitorData.Visitor_IP_Address,
    User_Agent: visitorData.User_Agent,
    //Platform: visitorData.Platform,
   // Screen_Resolution: visitorData.Screen_Resolution,
   // Web_Url: visitorData.Web_Url,
   // Chat_Origin: visitorData.Chat_Origin,
   // EngagementType: visitorData.EngagementType
  };

  embeddedservice_bootstrap.prechatAPI.setVisiblePrechatFields(visibleFields);
  embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields(hiddenFields);

  console.log("Prechat fields set:", { visibleFields, hiddenFields });
}

// Initialize chat on button click
document.getElementById('openChatButton').addEventListener('click', function() {
  if (typeof embeddedservice_bootstrap !== 'undefined') {

    // Setup prechat fields when library is ready
    window.addEventListener("onEmbeddedMessagingReady", setPrechatFields, { once: true });

    // Initialize chat
    embeddedservice_bootstrap.init(
      '00DgL00000098b7', // Org ID
      'githubPOC',       // Deployment Name
      'https://orgfarm-699ab99d32-dev-ed.develop.my.site.com/ESWgithubPOC1755783616250',
      {
        scrt2URL: 'https://orgfarm-699ab99d32-dev-ed.develop.my.salesforce-scrt.com'
      }
    );
  } else {
    console.warn("embeddedservice_bootstrap is not loaded yet!");
  }
});
</script>
